# API работы с данными в UserDB
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Коды состояния [стандартные](http://en.wikipedia.org/wiki/List_of_HTTP_status_codes) и возвращаются всегда. Клиент имеет право на их интерпретацию. Ошибки могут быть дополнительно подробно описаны в теле ответа запроса.

## Методы

### `/get_id_by_phone`
Запрос на проверку наличия идентификатора пользователя по номеру телефона.
```
POST https://{addr}/get_id_by_phone
```

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"phone":"380632224455"}' https://{addr}/get_id_by_phone
```

Сообщение отправляется в следующем формате:
```
{
  "phone": "string" // Телефон пользователя в международном формате
}
```

Пример первого сообщения:
```
{
  "phone": "380631234567"
}
```

Ответ будет получен в следующем формате:
```
{
  "id": "string" // Идентификатор пользователя
}
```

Пример ответа от сервиса:
```
{
  "id": "654886"
}
```

Возможны следующие коды состояния при отправке данных на сервис:
* `200` - данные успешно обработаны, отправлен ответ
* `404` - пользователь является непроверенным, либо не существует

### `/check_code`
Запрос на проверку смс кода введенного пользователем.
```
POST https://{addr}/check_code
```

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"phone":"380632223344", "code":"3854"}' https://{addr}/check_code
```

Запрос происходит в следующем формате:
```
{
  "phone": "string", // Телефон пользователя в международном формате
  "code":  "string"  // Код введенный пользователем
}
```

Возможны следующие коды состояния при отправке данных на сервис:
* `200` - смс код принят, пользователь допущен к бронированию
* `500` - код не принят

### `/send_code`
Запрос на отправку смс кода для пользователя. Код имеет срок жизни в течении 5-ти минут, после чего уничтожается, и для прохождения проверки, код нужно будет высылать повторно.
```
POST https://{addr}/send_code
```

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"phone":"380632223344"}' https://{addr}/send_code
```

Запрос происходит в следующем формате:
```
{
  "phone": "string" // Телефон пользователя в международном формате
}
```

Возможны следующие коды состояния при отправке данных на сервис:
* `200` - смс код отправлен
* `500` - нет возможности отправить смс код

### `/get_user`
Запрос на получение данных о пользователе.
```
POST https://{addr}/get_user
```

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"id":"3282117810"}' https://{addr}/get_user
```

Сообщение отправляется в следующем формате:
```
{
  "id": "string" // Идентификатор пользователя
}
```

В случае успеха, будет получена информация в следующем формате:
```
{
  "id":        "string", // Идентификатор пользователя
  "phone":     "string", // Телефон пользователя в международном формате
  "cert":      bool,     // Статус аутентификации пользователя
  "user_name": "string"  // Имя пользователя (в случае его наличия)
}
```

Пример ответа от сервиса:
```
{
  "id":    "654886", 
  "phone": "380683335566",
  "cert":  true,
  "user_name": "Иван Иванович"
}
```

Возможны следующие коды состояния при отправке данных на сервис:
* `200` - запрос успешно обработан
* `404` - пользователь не найден

### `/set-username`
Метод для записи (перезаписи) имени пользователя по его идентификатору
```
POST https://{addr}/set-username
```

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"id":"3282117810"}' https://{addr}/set-username
```

Сообщение отправляется в следующем формате:
```
{
  "id": "string",       // Идентификатор пользователя
  "user_name": "string" // Имя пользователя
}
```

Пример тела сообщения:
```
{
  "id": "3282117810",
  "user_name": "Иван Иванович"
}
```

Возможны следующие коды состояния при отправке данных на сервис:
* `200` - запрос успешно обработан
* `404` - пользователь не найден

### `/get-user-orders`
Метод получения списка всех заказов по идентификатору пользователя
```
POST https://{addr}/get-user-orders
```

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"id":"3282117810"}' https://{addr}/get-user-orders
```

Сообщение отправляется в следующем формате:
```
{
  "id": "string" // Идентификатор пользователя
}
```

Пример тела сообщения:
```
{
  "id": "3282117810"
}
```

Формат тела ответа:
```
{
  "user_name": "string",             // Имя пользователя (в случае его наличия в базе)
  "orders": [{
              "phone":   "string",   // Телефон пользователя 
              "id_shop": "string",   // Идентификатор торговой точки 

              "id_order": "string",  // Номер брони в аптеке
              "state":    "string",  // Статус обработки запроса
              "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
              "shipping":  "string", // Способ доставки товара
    "data": [{
        "id": "string",              // Идентификатор товара
        "quant": 0.0,                // Количество
        "price": 0.0                 // Цена
    }]
  }]
}
```

Где поле `"shipping"` описывает способ доставки заказа:
* `pickup`  - заказ клиент заберет самостоятельно.
* `deliver` - заказ необходимо доставить клиенту.


Поле `state` описывает текущее состояние заказа:
* `Accepted`  - заказ принят, бронь обрабатывается.
* `Confirmed` - заказ подтвержден и зарезервирован в торговой точке.
* `Updated`   - заказ изменен со стороны торговой точки
* `Changed`   - заказ был изменен покупателем
* `Completed` - заказ был продан покупателю
* `Canceled`  - заказ был отменен торговой точкой, либо покупателем

Пример тела ответа:
```
{
  "user_name": "Иван Иванович", 
  "orders": [{
        "phone":   "380365552233", 
        "id_shop": "800600",    
    
        "id_order": "000001",
        "state":    "New",
        "shipping": "pickup",
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "phone":   "380365552233", 
        "id_shop": "800600", 
  
        "id_order":  "012345",
        "state":     "Confirmed",
        "order_exp": 11154655,
        "shipping":  "pickup",
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

Возможны следующие коды состояния при отправке данных на сервис:
* `200` - запрос успешно обработан
* `500` - ошибка работы сервиса

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[cURL]:https://ru.wikipedia.org/wiki/CURL
