# API бронирования данных в geoapteka.ua/ru для аптечных сетей
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол отправки данных [HTTP], приема - [NATS]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Обмен данными происходит посредством кодов из каталога компании Морион.

4. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.

## Принцип работы

### Соединение
1. Тип соединения с [NATS] - [TLS]

2. Для соединения, вам понадобится IP-адрес, а также Логин и Пароль, которые вы можете узнать у вашего менеджера.

3. При подключении к сервису [NATS], торговой точке необходимо пройти процедуру регистрации.

### Обмен данными
1. После успешной регистрации, торговая точка подключается к одному из каналов для постоянного прослушивания.

2. Один из каналов торговая точка прослушивает в режиме реального времени, и использует его непосредственно для бронирования товаров.
Во второй приходят запросы для проверки остатков по товарам.

3. При получении данных из канала бронирования, торговая точка должна *присвоить* заказу один из двух статусов, в специальном поле формата, и отдать ответ по принципу Request–Response.

4. В случае отмена брони, ее продаже, или изменении номенклатуры при продаже, торговая точка *отсылает полный набор обновленных данных* используя HTTP метод.

5. Предусмотрен вариант демонстрационного бронирования, при котором торговая точка получит специальный флаг, который информирует ее о том, что клиент не намерен реально бронировать товар.
В этом случае, торговая точка просто отдает данные, помечая ее соответствующим статусом, но реальное бронирование по остаткам не выполняет.

6. При штатном завершении работы, торговая точка отключается от канала прослушивания посредством команды `connect.Close()` из пакета [NATS].

## Методы

### `/online_reg`
Регистрация. [HTTP] метод.
Используется для идентификации торговой точки в API и получение каналов для работы с клиентами.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/apt/online_reg
```
Где:
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.

Запрос отправляется в следующем формате:
```
{
  "ver":  "string", // Версия АПИ, которую будет использовать торговая точка
  "name": "string", // Название торговой точки
  "head": "string", // Название торговой сети (юр. лица)
  "addr": "string"  // Адрес торговой точки
}
```

В случае успеха, в ответе на запрос, будут получены JSON-данные следующего формата:
```
{
  "ch_booking": "string", // Название канала для бронирования товаров
  "ch_stock":   "string", // Название канала для запроса по остаткам
  "ch_status":  "string", // Название канала для отправки обновленных данных по измененным заказам
  "id":         "string"  // Идентификатор точки
}
```

### Прослушивание и бронирование
Real-time соединение. [NATS] метод.
Данный метод используется для прослушивания запросов от клиентов, и обратного ответа по принципу Request–Response.

Запросы от клиентов будут приходить в следующем формате:
```
{
  "phone":     "string", // Телефон пользователя 
  "id_shop":   "string", // Идентификатор торговой точки 
  "test":      false,    // Флаг тестового запроса
  "order_num": "string", // Номер брони
   "data": [{
      "id": "string",    // Идентификатор товара
      "quant": 0.0,      // Количество
      "price": 0.0       // Цена
   }]
}
```

Пример запроса от клиента:
```
{
  "phone":     "380365552233", 
  "id_shop":   "800600", 
  "test":       false,
  "order_num": "866523",
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
   }]
}
```

Отвечает торговая точка следующим форматом:
```
{
  "phone":   "string",   // Телефон пользователя 
  "id_shop": "string",   // Идентификатор торговой точки 
  "test":    false,      // Флаг тестового запроса      

  "state":     "string", // Статус обработки запроса
  "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
  "order_num": "string", // Номер брони в аптеке
    "data": [{
        "id": "string",  // Идентификатор товара
        "quant": 0.0,    // Количество
        "price": 0.0     // Цена
    }]
}
```

Пример такого ответа:
```
{
  "phone":   "380365552233", 
  "id_shop": "800600", 
  "test":    false,        

  "state":     "Confirmed",
  "order_exp": 11154655,
  "order_num": "012345",
    "data": [{
        "id": "56548",
        "quant": 1.0,
        "price": 35.10
    }]
}
```

Где поле `state` описывает текущее состояние заказа:
* `Confirmed` - заказ принят, бронь зарезервирована.
* `Updated`   - запрос в аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статус кодом**.

### `/online_upd`
Обновление данных по заказу. [HTTP] метод.
Запрос на обновления данных по `заказу` в торговой точке.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/apt/online_upd
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.

Формат запроса на обновления данных:
```
{
  "phone":   "string",   // Телефон пользователя 
  "id_shop": "string",   // Идентификатор торговой точки 
  "test":    false,      // Флаг тестового запроса      

  "state":     "string", // Статус обработки запроса
  "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
  "order_num": "string", // Номер брони в аптеке
    "data": [{
        "id": "string",  // Идентификатор товара
        "quant": 0.0,    // Количество
        "price": 0.0     // Цена
    }]
}
```

Где поле `"state"` описывает текущее состояние брони:
* `Updated`   - заказ изменен со стороны торговой точки
* `Changed`   - заказ был изменен покупателем
* `Completed` - заказ был продан покупателю
* `Canceled`  - заказ был отменен торговой точкой, либо покупателем

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом**.

Пример данного запроса:
```
{
  "phone":   "380365552233", 
  "id_shop": "800600", 
  "test":    false,        

  "state":     "Confirmed",
  "order_exp": 11154655,
  "order_num": "012345",
    "data": [{
        "id": "56548",
        "quant": 1.0,
        "price": 35.10
    }]
}
```

### `/stock_req`
[HTTP] метод, позволяющий получить информацию по товарам в конкретной торговой точке. Предусмотрен для взаимодействия торговых точек между собой. При указании соответствующего Юзер-Агента возможен обмен данными внутренними кодами торговой сети.

Запрос приходит в следующем формате:
```
{
  "agent":   "string", // Маркер точки запроса
  "id_shop": "string"  // Идентификатор торговой точки 
    "data": [{
        "id": "string" // Идентификатор товара
    }]
}
```

Пример первого сообщения:
```
{
  "agent":   "GeoApt", // Маркер точки запроса
  "id_shop": "800600"  // Идентификатор торговой точки 
    "data": [{
        "id": "512365" // Идентификатор товара
    }]
}
```

Отвечает торговая точка следующим форматом:
```
{
  "agent":   "string",  // Идентификатор точки запроса
  "id_shop": "string"   // Идентификатор торговой точки      
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример ответа от торговой точки:
```
{
  "agent":   "GeoApt",  // Идентификатор точки запроса
  "id_shop": "800600"   // Идентификатор торговой точки      
    "data": [{
        "id": "512365", // Идентификатор товара
        "quant": 2.0,   // Количество (float)
        "price": 15.65  // Цена (float)
    }]
}
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[TCP]:https://ru.wikipedia.org/wiki/TCP
[TLS]:https://ru.wikipedia.org/wiki/TLS
[NATS]:http://nats.io
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
