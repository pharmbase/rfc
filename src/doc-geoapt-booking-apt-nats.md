# API бронирования данных в geoapteka.ua/ru для аптечных сетей
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

## Принцип работы

### Соединение
1. Тип соединения с [NATS] - [TLS]

2. Для соединения, вам понадобится IP-адрес, а также Логин и Пароль, которые вы можете узнать у вашего менеджера.

3. При подключении к сервису [NATS], торговой точке необходимо пройти процедуру регистрации.
Для этого, посредством драйвера [NATS] отправляются данные в канал `655c445.register`, который, после успешной проверки выдаст название каналов для работы с ними. 

### Обмен данными
1. После успешной регистрации, торговая точка подключается к одному из каналов для постоянного прослушивания.

2. Один из каналов торговая точка прослушивает в режиме реального времени, и использует его непосредственно для бронирования товаров.
Во второй канал отправляются обновленные данные по забронированному ранее товару (продан, отменен, изменен)
В третий приходят запросы для проверки остатков по товарам.

3. При получении данных из канала бронирования, торговая точка должна *присвоить* заказу один из двух статусов, в специальном поле формата, и отдать ответ по принципу Request–Response.

4. В случае отмена брони, ее продаже, или изменении номенклатуры при продаже, торговая точка *отсылает полный набор обновленных данных* в канал обновлений, который не прослушивается в реальном времени, по принципу Request–Response.

5. Предусмотрен вариант демонстрационного бронирования, при котором торговая точка получит специальный флаг, который информирует ее о том, что клиент не намерен реально бронировать товар.
В этом случае, торговая точка просто отдает данные, помечая ее соответствующим статусом, но реальное бронирование по остаткам не выполняет.

## Методы

### Регистрация
Используется для идентификации торговой точки в API и получение двух каналов для работы с клиентами.

Запрос отправляется в следующем формате:
```
{
  "ver":  "string", // Версия АПИ, которую будет использовать торговая точка
  "name": "string", // Название торговой точки
  "head": "string", // Название торговой сети (юр. лица)
  "addr": "string"  // Адрес торговой точки
}
```

В случае успеха, в ответе на запрос, будут получены JSON-данные следующего формата:
```
{
  "ch_booking": "string", // Название канала для бронирования товаров
  "ch_stock":   "string", // Название канала для запроса по остаткам
  "ch_status":  "string", // Название канала для отправки обновленных данных по измененным заказам
  "id":         "string"  // Идентификатор точки
}
```

Если, по ряду причин, API не может выдать каналы, будет получен следующий формат, с описанием ошибки:
```
{
  "code": "string", // Код ошибки
  "text": "string"  // Описание ошибки
}
``` 

### Прослушивание и бронирование
Данный метод используется для прослушивания запросов от клиентов, и обратного ответа по принципу Request–Response.

Запросы от клиентов будут приходить в следующем формате:
```
{
    "meta": {
        "agent":   "string", // Маркер точки запроса
        "phone":   "string", // Телефон пользователя 
        "id_shop": "string", // Идентификатор торговой точки 
        "test":     bool     // Флаг тестового запроса
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример запроса от клиента:
```
{
    "meta": {
        "agent":   "GeoApt",
        "phone":   "380365552233", 
        "id_shop": "800600", 
        "test":    false     
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
}
```

Отвечает торговая точка следующим форматом:
```
{
    "meta": {
        "agent":   "string", // Идентификатор точки запроса
        "phone":   "string", // Телефон пользователя 
        "id_shop": "string", // Идентификатор торговой точки 
        "test":    bool,     // Флаг тестового запроса      

        "state":     "string", // Статус обработки запроса ("ACCEPT", "REPEAT")
        "order_exp": int64,    // Срок истечения брони в аптеке, в формате Unixtime
        "order_num": "string"  // Номер брони в аптеке (в случае успешного бронирования)
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример такого ответа:
```
{
    "meta": {
        "agent":   "GeoApt",
        "phone":   "380365552233", 
        "id_shop": "800600", 
        "test":    false,        

        "state":     "ACCEPT",
        "order_exp": 11154655,
        "order_num": "P-001"
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
}
```

Где статус код описывает текущее состояние брони:
* `ACCEPT` - заказ принят, бронь зарезервирована.
* `REPEAT` - запрос в аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статус кодом**.

### Изменение статуса бронирования
В случае, продажи, изменение заказа, либо его отмены, торговая точка отправляет запрос в канал обновления бронирования по принципу Request–Response.

Запрос выполняется в следующем формате:
```
{
    "meta": {
        "agent":   "string", // Идентификатор точки запроса
        "phone":   "string", // Телефон пользователя 
        "id_shop": "string", // Идентификатор торговой точки 

        "state":     "string", // Статус обработки запроса ("UPDATE", "CANCEL", "COMPLETE")
        "order_exp": int64,    // Срок истечения брони в аптеке, в формате Unixtime
        "order_num": "string"  // Номер брони в аптеке
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример данного запроса:
```
{
    "meta": {
        "agent":   "GeoApt",
        "phone":   "380365552233", 
        "id_shop": "800600", 
        "test":    false,        

        "state":     "CANCEL",
        "order_exp": 11154655,
        "order_num": "P-001"
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    }]
}
```

Где статус код описывает текущее состояние брони:
* `UPDATE` - бронь была изменена, в запросе отправляются новые данные о бронировании
* `CANCEL` - бронь отменили
* `COMPLETE` - забронированный товар был продан, в запросе так же отправляется перечень проданных товаров

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статус кодом**.

Во всех случаях API отдаст ответ в следующем формате:
```
{
  "code": "string", // Код ответа
  "text": "string"  // Описание ответа
}
```

### Запрос по остаткам товара в торговой точке

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[TCP]:https://ru.wikipedia.org/wiki/TCP
[TLS]:https://ru.wikipedia.org/wiki/TLS
[NATS]:http://nats.io
