# API бронирования данных в geoapteka.ua/ru для аптечных сетей
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP] и [HTTPS]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Общий url-формат:
  ```
  POST http://{addr}/{aspect}/{user}/{action}
  ```

4. Коды состояния [стандартные](http://en.wikipedia.org/wiki/List_of_HTTP_status_codes) и возвращаются всегда. Клиент имеет право на их интерпретацию. Ошибки могут быть дополнительно подробно описаны в теле ответа запроса.

## Подключение
1. Для получения данных, торговая точка подключается к очереди сообщений. В конкретном случае - [NSQ]

2. Протокол получения данных с [NSQ] - [HTTPS]

3. После успешного прохождения регистрации, торговая точка получает собственный канал для подключения, следующего формата:
  ```
  {aspect}-{id}
  ```
Пример канала:
   ```
  Booking-854133
  ``` 

4. Запросы от клиентов будут приходить в следующем формате:
```
{
    "meta": {
        "id":      "string", // Идентификатор запроса
        "id_shop": "string", // Идентификатор торговой точки
        "id_lang": "string", // Идентификатор языка ("ru", "ua")

        "cli_name":   "string", // Имя
        "cli_phone":  "string", // Телефон
        "cli_email":  "string", // Эл. почта
        "cli_expiry": "string"  // Время истечение срока брони в формате ISO 8601 02-01-2006 15:04
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```
Пример запроса от клиента:
```
{
    "meta": {
        "id":      "hasdh1hkasdk123kasdaks",
        "id_shop": "500111",
        "id_lang": "ru",

        "cli_name":   "Иван Иванович Иванов",
        "cli_phone":  "+380631234567",
        "cli_email":  "test@testmail.com",
        "cli_expiry": "31-09-2015 19:45"
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 256.88
    },{
        "id": "1124",
        "quant": 2.0,
        "price": 56.08
    }]
}
```

## Работа с сервисом
После подключения к [NSQ], все ответы от торговой точки посылаются на сервис посредством [HTTP] соединения.

## Методы

### `/register`
Регистрация торговой точки при включении.
```
POST http://{addr}/booking/apt/register
```

Сообщение отправляется в следующем формате:
```
{
  "meta": {
    "name": "string", // Название торговой точки
    "head": "string", // Название торговой сети (юр. лица)
    "addr": "string"  // Адрес торговой точки
  }
}
```

Так же, при отправке обязательно указывается параметр заголовка *X-Morion-Skynet-Key*.

Значение параметра *X-Morion-Skynet-Key*:
* Устанавливается при подписании договора, уточняйте у вашего менеджера

Пример команды отправки файла с данными *data.json* при помощи служебной программы [cURL]:
```sh
curl -X POST -T "data.json" -H "X-Morion-Skynet-Key: xxxxxxxx" http://{addr}/booking/apt/register
```

В случае успеха, будет получено имя канала для подключения к [NSQ], в следующем формате:
```
{
    "topic_name": "string" // Имя канала для прослушивания
}
```

Возможны следующие коды состояния:
* `202` - канал выдан
* `204` - данной аптеки нет в базе данных

### `/alive`
Сообщение сервису о готовности принимать сообщения.
```
POST http://{addr}/booking/apt/alive
```

В период времени N (1800 секунд), торговой точкой отправляется данная команда, которая сообщает серверу о готовности принимать запросы от клиентов. В противном случае, до получения новой команды, торговая точка не будет получать данные от клиентов.

Запрос выполняется в следующем формате:
```
{
    "topic_name": "string" // Имя канала, который выдан сервисом при регистрации
}
```

Пример команды отправки файла с данными *data.json* при помощи служебной программы [cURL]:
```sh
curl -X POST -T "data.json" http://{addr}/booking/apt/alive
```

Ответ будет получен всегда, в следующем формате:
```
202
```

### `/responce`
Отправка сервису данных о бронировании.
```
POST http://{addr}/booking/apt/responce
```

Отправка выполняется в следующем формате:
```
{
    "meta": {
        "id":      "string", // Идентификатор запроса
        "id_shop": "string", // Идентификатор торговой точки
        "id_lang": "string", // Идентификатор языка ("ru", "ua")

        "cli_name":   "string", // Имя
        "cli_phone":  "string", // Телефон
        "cli_email":  "string", // Эл. почта
        "cli_expiry": "string", // Время истечение срока брони в формате ISO 8601 02-01-2006 15:04

        "apt_status_code": "string", // Статус обработки запроса ("ACCEPT", "REPEAT")
        "apt_status_text": "string", // Сообщение клиенту от аптеки
        "apt_num_order":   "string"  // Номер брони в аптеке (в случае успешного бронирования)
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```
Пример ответа от торговой точки:
```
{
    "meta": {
        "id":      "hasdh1hkasdk123kasdaks",
        "id_shop": "500111",
        "id_lang": "ru",

        "cli_name":   "Иван Иванович Иванов",
        "cli_phone":  "+380631234567",
        "cli_email":  "test@testmail.com",
        "cli_expiry": "31-09-2015 19:45",

        "apt_status_code": "ACCEPT",
        "apt_status_text": "Спасибо за покупку!",
        "apt_num_order":   "P-001"
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
}
```

Где статус код описывает текущее состояние брони:
* ACCEPT - заказ принят, бронь зарезервирована.
* REPEAT - запрос в аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)
* UPDATE - бронь была изменена, в запросе отправляются новые данные о бронировании
* CANCEL - бронь отменили, в поле "status_text" указывается причина отмены
* COMPLETE - забронированный товар был продан, в запросе так же отправляется перечень проданных товаров

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статус кодом**.

Пример команды отправки файла с данными *responce.json* при помощи служебной программы [cURL]:
```sh
curl -X POST -T "responce.json" http://{addr}/booking/apt/responce
```

Возможны следующие коды состояния при отправке данных на сервис:
* `202` - данные успешно приняты и переданы клиенту
* `408` - клиент прервал соединение, либо аптека превысила время ожидания ответа

### `/unregister`
Извещения сервиса о штатном прекращении работы торговой точки.
```
POST http://{addr}/booking/apt/unregister
```

Запрос выполняется в следующем формате:
```
{
    "topic_name": "string" // Имя канала, который выдан сервисом при регистрации
}
```

Пример команды отправки файла с данными *data.json* при помощи служебной программы [cURL]:
```sh
curl -X POST -T "data.json" http://{addr}/booking/apt/unregister
```

Ответ будет получен всегда, в следующем формате:
```
202
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[HTTPS]:https://ru.wikipedia.org/wiki/HTTPS
[cURL]:https://ru.wikipedia.org/wiki/CURL
[NSQ]:http://nsq.io/
