# API Offline бронирования данных в geoapteka.ua/ru для аптечных сетей
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Коды состояния [стандартные](http://en.wikipedia.org/wiki/List_of_HTTP_status_codes) и возвращаются всегда. Клиент имеет право на их интерпретацию. Ошибки могут быть дополнительно подробно описаны в теле ответа запроса.

4. Обмен данными происходит посредством кодов из каталога компании Морион.

5. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.

## Методы

### `/morion_req`
Запрос на получение всех заказов для предоставленного ключа.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST http://{addr}/cli/morion_req
```
Где: 
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.

В случае успеха, будет получен ответ от АПИ в следующем формате:
```
[
 {
   "phone":   "string",   // Телефон пользователя 
   "id_shop": "string",   // Идентификатор торговой точки 
   "test":    false,      // Флаг тестового запроса      

   "state":     "string", // Статус обработки запроса
   "order_num": "string", // Номер брони
    "data": [{
        "id": "string",   // Идентификатор товара
        "quant": 0.0,     // Количество
        "price": 0.0      // Цена
    }]
  }
] 
```

Пример такого ответа:
```
[
  {
    "phone":   "380365552233", 
    "id_shop": "800600", 
    "test":    false,        

    "state":     "Accepted",
    "order_num": "000001",
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
 },{
    "phone":   "380367773355", 
    "id_shop": "700100", 
    "test":    false,        

    "state":     "Accepted",
    "order_num": "000002",
    "data": [{
        "id": "75748",
        "quant": 1.0,
        "price": 25.70
    }]
  }
] 
```

Где `"state"` описывает текущее состояние брони:
* `Accepted` - новый заказ, который ожидает обработки

В случае отсутствия заказов для сети, будет получен пустой ответ.


### `/morion_upd`
Запрос на обновления данных по `заказу` в `конкретной` торговой точке.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/cli/morion_upd
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.

Формат запроса на обновления данных:
```
{
  "phone":   "string",   // Телефон пользователя 
  "id_shop": "string",   // Идентификатор торговой точки 
  "test":    false,      // Флаг тестового запроса      

  "state":     "string", // Статус обработки запроса
  "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
  "order_num": "string", // Номер брони в аптеке
    "data": [{
        "id": "string",  // Идентификатор товара
        "quant": 0.0,    // Количество
        "price": 0.0     // Цена
    }]
}
```

Где `"state"` описывает текущее состояние брони:
* `Confirmed` - заказ подтвержден и зарезервирован в торговой точке.
* `Updated`   - заказ изменен со стороны торговой точки
* `Changed`   - заказ был изменен покупателем
* `Completed` - заказ был продан покупателю
* `Canceled`  - заказ был отменен торговой точкой, либо покупателем

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом**.

Пример данного запроса:
```
{
  "phone":   "380365552233", 
  "id_shop": "800600", 
  "test":    false,        

  "state":     "Confirmed",
  "order_exp": 11154655,
  "order_num": "012345",
    "data": [{
        "id": "56548",
        "quant": 1.0,
        "price": 35.10
    }]
}
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[cURL]:https://ru.wikipedia.org/wiki/CURL
