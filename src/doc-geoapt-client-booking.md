# API Обмена данными в geoapteka.ua/ru
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Обмен данными происходит посредством кодов из каталога компании Морион.

4. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `403` - неверный логин или пароль в запросе.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.

## Принцип работы

### Обмен данными

1. Для отправки данных используется Url-адрес следующего формата:
  ```
  POST http://{addr}/{user}/{action}
  ```
 
  К примеру:
  ```
  POST http://{addr}/cli/request
  ```
  Где `{addr}` - IP-адрес API, который вы можете узнать у вашего менеджера.

2. Ответ от сервиса на бронирование заказа будет получен всегда. Формат ответа является единым. В случае успешного бронирования будет получен стандартный ответ. В случае несовпадения товара либо цены в Online-точке, будет получен стандартный формат с внесенными в него изменениями и соотвествующим статусом.

## Методы

### `/order`
Запрос на обработку нового заказа.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" -u login:password http://{addr}/cli/order
```
Где:
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `login`      - логин HTTP аутентификации.
- `password`   - пароль HTTP аутентификации.

Первое сообщение отправляется в следующем формате:

**При заказе нескольких товаров в одну и ту же торговую точку - товары группируются.**
```
{
  "agent": "string",          // Маркер точки запроса (например: "ServiceName")
  "phone": "string",          // Телефон пользователя
  "shops": [{
        "id_shop":       "string", // Идентификатор торговой точки
        "ext_id_shop" :  "string", // Внешний идентификатор (идентификаторы)
        "shipping":      "string", // Способ доставки товара (при доставке указывается поставщик)
        "delivery_date": "string", // Дата доставки (заполняется при доставке)
        "delivery_time": "string", // Время доставки (заполняется при доставке)
    "data": [{
        "id":     "string",    // Идентификатор товара
        "quant": 0.0,          // Количество
        "price": 0.0           // Цена
    }]
  }]
}
```
**Для заказов с доставкой из Оптимы, в поле "ext_id_shop" также добавляется внешний идентификатор Оптимы по формату "123|456", где 123 - внешний идентификатор аптеки, | - разделитель, 456 - внешний идентификатор Оптимы.**

Пример первого сообщения:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "shops": [{
        "id_shop":  "700555",
        "ext_id_shop" :  "652255|300800", 
        "shipping":      "optima", 
        "delivery_date": "2021-08-18",
        "delivery_time": "09:00", 
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop":  "800900",
        "shipping": "pickup",
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

В случае успеха, будет получен ответ в следующем формате:
```
{
  "agent":    "string",        // Маркер точки запроса (например: "ServiceName")
  "phone":    "string",        // Телефон пользователя
  "id_order": "string",        // Идентификатор заказа
  "gl_state": "string",        // Статус обработки всего заказа
  "shops": [{
        "id_shop":       "string", // Идентификатор торговой точки
        "ext_id_shop" :  "string", // Внешний идентификатор (при доставке)
        "state":         "string", // Статус обработки заказа
        "shipping":      "string", // Способ доставки товара (при доставке указывается поставщик)
        "delivery_date": "string", // Дата доставки (заполняется при доставке)
        "delivery_time": "string", // Время доставки (заполняется при доставке)        
        "order_exp": 0,            // Срок истечения заказа в аптеке, в формате Unixtime (в случае успешного бронирования в Online точке)       
    "data": [{
        "id": "string",        // Идентификатор товара
        "quant": 0.0,          // Количество
        "price": 0.0           // Цена
    }]
  }]
}
```

Пример ответа от сервиса:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "id_order": "884654",
  "gl_state": "Accepted", 
  "shops": [{
        "id_shop":       "800600",
        "ext_id_shop" :  "652255|300800", 
        "state":         "Accepted",
        "shipping":      "optima", 
        "delivery_date": "2021-08-18",
        "delivery_time": "09:00",         
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop":  "500800",
        "shipping": "pickup",
        "state":    "Confirmed",
        "order_exp": 12355465,  
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

Где поле `"shipping"` описывает способ доставки заказа:
* `pickup` - заказ клиент заберет самостоятельно.
* `optima` - заказ необходимо доставить клиенту.

Поле `gl_state` описывает текущее состояние всего заказа из корзины:
* `Accepted` - заказ принят, и поступил на обработку.
* `Canceled` - заказ не принят, в случае, если хотя бы один из подзаказов не принят на обработку в АПИ

Поле `state` описывает текущее состояние подзаказа:
* `Accepted` - заказ принят, бронь обрабатывается.
* `Updated`  - запрос в Online аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)
* `Confirmed`- заказ в Online точку успешно обработан и товар забронирован на срок, указанный в поле `order_exp`.

В случае, если поле `gl_state` содержит `Canceled`, клиент может сделать повторный запрос, с обновленными данными, полученными от торговых точек.
При повторном запросе отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом**.

Например:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "id_order": "884654",
  "gl_state": "Canceled", 
  "shops": [{
        "id_shop":  "800600",
        "shipping": "pickup",
        "state":    "Accepted",
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    }]
},{     "id_shop":  "500800", 
        "shipping": "pickup",
        "state":    "Updated",
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

### `/test-order`
Метод [HTTP]. Позволяет самостоятельно составлять тестовый заказ для проверки функционала доставки сообщений.

Пример:
```sh
curl -X POST -T "order.json" -u user:password http://{addr}/test-order
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `user`       - логин (имя пользователя).
- `password`   - пароль HTTP аутентификации (ключ облачной авторизации).

Формат тела тестового запроса:
```
{
  "agent": "string",          // Маркер точки запроса (например: "ServiceName")
  "phone": "string",          // Телефон пользователя
  "shops": [{
        "id_shop":       "string", // Идентификатор торговой точки
        "ext_id_shop" :  "string", // Внешний идентификатор (идентификаторы)
        "shipping":      "string", // Способ доставки товара (при доставке указывается поставщик)
        "delivery_date": "string", // Дата доставки (заполняется при доставке)
        "delivery_time": "string", // Время доставки (заполняется при доставке)
    "data": [{
        "id":     "string",    // Идентификатор товара
        "quant": 0.0,          // Количество
        "price": 0.0           // Цена
    }]
  }]
}
```
Где поле `"shipping"` описывает способ доставки заказа:
* `pickup` - заказ клиент заберет самостоятельно.
* `optima` - заказ необходимо доставить клиенту.

Обрабатываются тестовые заказы, теми же методами, что и реальные, отличаются от реальных наличием поля `"test": true` в теле запроса.

Пример тела тестового запроса:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "shops": [{
        "id_shop":  "700555",
        "ext_id_shop" :  "652255|300800", 
        "shipping":      "optima", 
        "delivery_date": "2021-08-18",
        "delivery_time": "09:00", 
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop":  "800900",
        "shipping": "pickup",
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[cURL]:https://ru.wikipedia.org/wiki/CURL
