# API обмена данными в geoapteka.ua/ru (V 1.0)
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Коды состояния [стандартные](http://en.wikipedia.org/wiki/List_of_HTTP_status_codes) и возвращаются всегда. Клиент имеет право на их интерпретацию. Ошибки могут быть дополнительно подробно описаны в теле ответа запроса.

4. Обмен данными происходит посредством кодов из каталога компании Морион.

5. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.

## Принцип работы

### Обмен данными

1. Для отправки данных используется Url-адрес следующего формата:
  ```
  POST http://{addr}/{aspect}/{user}/{action}
  ```
 
  К примеру:
  ```
  POST http://{addr}/booking/cli/request
  ```
  Где `{addr}` - IP-адрес API, который вы можете узнать у вашего менеджера.

2. Предусмотрен вариант демонстрационного бронирования, при котором торговая точка получит специальный флаг, который информирует ее о том, что клиент не намерен реально бронировать товар.
В этом случае, торговая точка просто отдает данные, помечая ее соответствующим статусом, но реальное бронирование по остаткам не выполняет.

## Методы

### `/ping`
POST-метод позволяющий получить информацию по торговой точке

Пример команды при помощи служебной программы [cURL]:
```sh
curl -i -X POST -H "Content-Type: application/json" -d '{"id":"888600"}' http://{addr}/booking/cli/ping
```

Запрос отправляется в следующем формате:
```
{
  "id": "string" // Идентификатор торговой точки
}
```

В случае успеха, будет получен ответ следующего формата:
```
{
  "shop_ver": "string",     // Версия АПИ, которую использует торговая точка
  "shop_method": ["string"] // Перечень методов, которые использует торговая точка
}
```

### `/req_booking`
Запрос на создание брони в торговой точке.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/booking/cli/req_booking
```
Где `order.json` - набор данных JSON-формата, может быть отправлен в любом виде.

При отправке запроса, указывается следующий параметр:
* `X-Api-Version` - указывает версию протокола, с которой будет работать API.
Например: `X-Api-Version: 1.0`

Первое сообщение отправляется в следующем формате:
```
{
    "meta": {
        "user_agent": "string", // Маркер точки запроса
        "user_phone": "string", // Телефон пользователя 
        "id_shop":    "string", // Идентификатор торговой точки 
        "test_flag":   bool     // Флаг тестового запроса
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример первого сообщения:
```
{
    "meta": {
        "user_agent": "GeoApt",
        "user_phone": "380365552233", 
        "id_shop":    "800600", 
        "test_flag":   false     
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
}
```

В случае успеха, будет получен ответ в следующем формате:
```
{
    "meta": {
        "user_agent": "string", // Идентификатор точки запроса
        "user_phone": "string", // Телефон пользователя 
        "id_shop":    "string", // Идентификатор торговой точки 
        "test_flag":  bool,     // Флаг тестового запроса      

        "apt_status_code": "string", // Статус обработки запроса ("ACCEPT", "REPEAT")
        "apt_order_exp":    int64,   // Срок истечения брони в аптеке, в формате Unixtime
        "apt_order_num":   "string"  // Номер брони в аптеке (в случае успешного бронирования)
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример ответа от торговой точки:
```
{
    "meta": {
        "user_agent": "GeoApt",
        "user_phone": "380365552233", 
        "id_shop":    "800600", 
        "test_flag":   false,        

        "apt_status_code": "ACCEPT",
        "apt_order_exp":   11154655,
        "apt_order_num":   "P-001"
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
}
```

Где статус код описывает текущее состояние брони:
* `ACCEPT` - заказ принят, бронь зарезервирована.
* `REPEAT` - запрос в аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)

В случае, если поле `apt_status_code` содержит `REPEAT`, клиент может сделать повторный запрос, с обновленными данными, полученными от торговой точки:
```
{
    "meta": {
        "user_agent": "string", // Маркер точки запроса
        "user_phone": "string", // Телефон пользователя 
        "id_shop":    "string", // Идентификатор торговой точки 
        "test_flag":   bool     // Флаг тестового запроса
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример повторного запроса для уточнения цены:
```
{
    "meta": {
        "user_agent": "GeoApt",
        "user_phone": "380365552233", 
        "id_shop":    "800600", 
        "test_flag":   false     
    },
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    }]
}
```

### `/req_stock`
Запрос по остаткам в торговой точке.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/booking/cli/req_stock
```
Где `order.json` - набор данных JSON-формата, может быть отправлен в любом виде.

При отправке запроса, указывается следующий параметр:
* `X-Api-Version` - указывает версию протокола, с которой будет работать API.
Например: `X-Api-Version: 1.0`

Первое сообщение отправляется в следующем формате:
```
{
    "meta": {
        "user_agent": "string", // Маркер точки запроса
        "id_shop":    "string"  // Идентификатор торговой точки 
    },
    "data": [{
        "id": "string" // Идентификатор товара
    }]
}
```

Пример первого сообщения:
```
{
    "meta": {
        "user_agent": "GeoApt", // Маркер точки запроса
        "id_shop":    "800600"  // Идентификатор торговой точки 
    },
    "data": [{
        "id": "512365" // Идентификатор товара
    }]
}
```

Отвечает торговая точка следующим форматом:
```
{
    "meta": {
        "user_agent": "string", // Идентификатор точки запроса
        "id_shop":    "string"  // Идентификатор торговой точки      
    },
    "data": [{
        "id": "string", // Идентификатор товара
        "quant": 0.0,   // Количество (float)
        "price": 0.0    // Цена (float)
    }]
}
```

Пример ответа от торговой точки:
```
{
    "meta": {
        "user_agent": "GeoApt", // Идентификатор точки запроса
        "id_shop":    "800600"  // Идентификатор торговой точки      
    },
    "data": [{
        "id": "512365", // Идентификатор товара
        "quant": 2.0,   // Количество (float)
        "price": 15.65  // Цена (float)
    }]
}
```

### `/get_id`
POST-метод позволяющий получить идентификатор торговой точки для работы с API

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/booking/cli/get_id
```
Где `order.json` - набор данных JSON-формата, может быть отправлен в любом виде.

Запрос отправляется в следующем формате:
```
{
  "name": "string",       // Название торговой точки
  "head": "string",       // Название торговой сети (юр. лица)
  "addr": "string"        // Адрес торговой точки
}
```

В случае успеха, будет получен ответ следующего формата:
```
{
  "id": "string" // Идентификатор торговой точки
}
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[cURL]:https://ru.wikipedia.org/wiki/CURL
