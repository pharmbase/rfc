# API обмена данными в geoapteka.ua/ru
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Обмен данными происходит посредством кодов из каталога компании Морион.

4. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.

## Принцип работы

### Обмен данными

1. Для отправки данных используется Url-адрес следующего формата:
  ```
  POST http://{addr}/{user}/{action}
  ```
 
  К примеру:
  ```
  POST http://{addr}/cli/request
  ```
  Где `{addr}` - IP-адрес API, который вы можете узнать у вашего менеджера.

2. Ответ от сервиса на бронирование заказа будет получен всегда. Формат ответа является единым. В случае успешного бронирования будет получен стандартный ответ. В случае несовпадения товара либо цены в Online-точке, будет получен стандартный формат с внесенными в него изменениями и соотвествующим статусом.

## Методы

### `/order`
Запрос на обработку нового заказа.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/cli/order_req
```
Где:
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.

**При заказе нескольких товаров в одну и ту же торговую точку - товары группируются.**
Первое сообщение отправляется в следующем формате:
```
{
  "agent": "string",         // Маркер точки запроса (например: "ServiceName")
  "phone": "string",         // Телефон пользователя
  "shops": [{
        "id_shop": "string", // Идентификатор торговой точки   
    "data": [{
        "id": "string",      // Идентификатор товара
        "quant": 0.0,        // Количество
        "price": 0.0         // Цена
    }]
  }]
}
```

Пример первого сообщения:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "shops": [{
        "id_shop": "700555",   
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop": "800900",   
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

В случае успеха, будет получен ответ в следующем формате:
```
{
  "agent":    "string",        // Маркер точки запроса (например: "ServiceName")
  "phone":    "string",        // Телефон пользователя
  "id_order": "string",        // Идентификатор заказа
  "shops": [{
        "id_shop":   "string", // Идентификатор торговой точки
        "state":     "string", // Статус обработки заказа
        "order_exp": 0,        // Срок истечения заказа в аптеке, в формате Unixtime (в случае успешного бронирования в Online точке)       
    "data": [{
        "id": "string",        // Идентификатор товара
        "quant": 0.0,          // Количество
        "price": 0.0           // Цена
    }]
  }]
}
```

Пример ответа от сервиса:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "id_order": "884654",           
  "shops": [{
        "id_shop":   "800600",
        "state":     "Accepted", 
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop":   "500800",
        "state":     "Confirmed",
        "order_exp": 12355465,  
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

Где поле `gl_state` описывает текущее состояние заказа:
* `Accepted` - заказ принят, бронь обрабатывается.
* `Updated`  - запрос в Online аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)
* `Confirmed`- заказ в Online точку успешно обработан и товар забронирован на срок, указанный в поле `order_exp`.

В случае, если поле `gl_state` содержит `Updated`, клиент может сделать повторный запрос, с обновленными данными, полученными от торговой точки.
При повторном запросе отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом**.

Например:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "id_order": "884654",         
  "shops": [{
        "id_shop":   "800600",
        "state":     "Accepted",
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    }]
},{     "id_shop":   "500800", 
        "state":     "Updated",
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

### `/get_id`
POST-метод позволяющий получить идентификатор торговой точки для работы с API

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/cli/get_id
```
Где:
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.

Запрос отправляется в следующем формате:
```
{
  "name": "string",       // Название торговой точки
  "head": "string",       // Название торговой сети (юр. лица)
  "addr": "string"        // Адрес торговой точки
}
```

В случае успеха, будет получен ответ следующего формата:
```
{
  "id": "string" // Идентификатор торговой точки
}
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[cURL]:https://ru.wikipedia.org/wiki/CURL
