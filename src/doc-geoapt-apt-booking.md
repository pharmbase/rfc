# API Бронирования данных в geoapteka.ua/ru для аптечных сетей
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP], а также [NATS] в качестве системы скоростной доставки.

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Обмен данными происходит посредством кодов и идентификаторов из каталога компании Морион.

4. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `403` - неверный логин или пароль в запросе.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.
  
## Принцип работы
АПИ предоставляет для клиентов гибкий инструментарий, дающий возможность обрабатывать заказы как централизовано, так и распределяя заказы по торговым точкам, используя различный транспорт для получения заказов. Для этого предоставляется набор методов, которые имеют разную сложность, скорость и надежность доставки.


### Соединение
1. Тип соединения с АПИ - [HTTP] 

2. Тип соединения с [NATS] - [TLS]

3. Для соединения, вам понадобится *адрес*, а также *логин* и *пароль*, которые вы можете узнать у вашего менеджера.

### Обмен данными
1. При использовании [NATS] соединения, АПИ ожидает ответа от клиентов в момент запроса, в случае, если ответ не получен, запрос считается неудачным.

2. При использовании остальных видов транспорта, у сети есть 10 минут на то, что бы забрать заказ и 30 минут на его обработку. Если в отведенное время сеть не обработала заказ, он передается на внутреннюю службу обработки Morion, и в дальнейшем, будет недоступен для сети.

3. Предусмотрен вариант демонстрационного бронирования, при котором торговая точка получит специальный флаг, который информирует ее о том, что клиент не намерен реально бронировать товар.
В этом случае, торговая точка просто отдает данные, помечая ее соответствующим статусом, но реальное бронирование по остаткам не выполняет.

4. Для использования любых видов транспорта, кроме забора заказов по оффлайну, клиенту необходимо указать для необходимых идентификаторов торговых точек такие параметры как способ доставки, и адрес доставки. Если вид транспорта не указывается, по умолчанию используется транспорт оффлайн доставки `/pop-order`. Методы для каждого вида транспорта отдельные и указаны ниже.


## Методы

### `/reg-nats`
[HTTP] метод. Позволяет зарегистрировать один или несколько каналов [NATS] для дальнейшего прослушивания с целью скоростной обработки заказов.
Допустимые симловы при названии канала: [`0-9`, `a-z`, `A-Z`, `-`, `_`]

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" -u login:password http://{addr}/reg-nats
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `login`      - логин HTTP аутентификации (`booking` - для участия в бронировании).
- `password`   - пароль HTTP аутентификации (ключ облачной авторизации).

Формат запроса выглядит следующим образом:
```
[
 {
   "id_shop":  "string", // Идентификатор торговой точки 
   "subject": "string"   // Название канала для данного идентификатора торговой точки     
 }
] 
```

Пример такого запроса:
```
[
 {
   "id_shop": "556546", 
   "subject": "hello_nats_1"      
 },
 {
   "id_shop": "122254", 
   "subject": "hello_nats_2"   
 }
] 
```

Если есть необходимость обрабатывать заказы из нескольких точек централизованно, допускается указание одного и того же названия канала в нескольких точках.

### `/get-id-shop`
[HTTP] метод. Позволяет получить идентификатор торговой точки для работы с API.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" -u login:password http://{addr}/get-id-shop
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `login`      - логин HTTP аутентификации (`booking` - для участия в бронировании).
- `password`   - пароль HTTP аутентификации (ключ облачной авторизации).

Запрос отправляется в следующем формате:
```
[
 {
   "name": "string", // Название торговой точки
   "head": "string", // Название торговой сети (юр. лица)
   "addr": "string"  // Адрес торговой точки
 }
] 
```

В случае успеха, будет получен ответ следующего формата:
```
[
 {
   "id": "string" // Идентификатор торговой точки
 }
] 
```

### `/set-order`
[HTTP] метод. Тестовый запрос, которым сеть может сымитировать запрос на заказ вручную. Позволяет самостоятельно составлять заказ (в кодах Мориона).

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" -u login:password http://{addr}/set-order
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `login`      - логин HTTP аутентификации (`booking` - для участия в бронировании).
- `password`   - пароль HTTP аутентификации (ключ облачной авторизации).

Формат тестового запроса:
```
{
  "agent": "string",          // Маркер точки запроса, например "CorpName"
  "phone": "string",          // Телефон пользователя 
  "shops": [{
        "id_shop":  "string", // Идентификатор торговой точки
        "shipping": "string", // Способ доставки товара
    "data": [{
        "id": "string",       // Идентификатор товара
        "quant": 0.0,         // Количество
        "price": 0.0          // Цена
    }]
  }]
}
```
Где поле `"shipping"` описывает способ доставки заказа:
* `pickup`  - заказ клиент заберет самостоятельно.
* `deliver` - заказ необходимо доставить клиенту.

Все заказы, сформированные тестовым запросом, получат маркер `"test": true`.
Обрабатываются тестовые заказы, теми же методами, что и реальные. 

Пример тестового запроса:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "shops": [{
        "id_shop":  "700555",
        "shipping": "pickup",
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop":  "800900",
        "shipping": "pickup",
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

### `/pop-order`
[HTTP] метод. Запрос на получение всех заказов для сети, которая участвует в бронировании.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" -u login:password http://{addr}/pop-order
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `login`      - логин HTTP аутентификации (`booking` - для участия в бронировании).
- `password`   - пароль HTTP аутентификации (ключ облачной авторизации).

Формат запроса на получение данных:
```
["string"] // Перечень идентификаторов торговых точек, по которым необходимо получить заказы
```

Пример данного запроса:
```
["111222", "333444", "5556667"]
```

Допускается вариант, при котором торговая сеть может централизовано получить все заказы для неё, в таком случае, в запросе отправляется пустой массив.
Например:
```
[]
```

В случае успеха, будет получен ответ от АПИ в следующем формате:
```
[
 {
   "phone":   "string",   // Телефон пользователя 
   "id_shop": "string",   // Идентификатор торговой точки 
   "test":    false,      // Флаг тестового запроса      

   "state":     "string", // Статус обработки запроса
   "order_num": "string", // Номер брони
   "shipping":  "string", // Способ доставки товара
    "data": [{
        "id": "string",   // Идентификатор товара
        "quant": 0.0,     // Количество
        "price": 0.0      // Цена
    }]
  }
] 
```

Где поле `"shipping"` описывает способ доставки заказа:
* `pickup`  - заказ клиент заберет самостоятельно.
* `deliver` - заказ необходимо доставить клиенту.

Поле `"state"` описывает текущее состояние брони:
* `New` - новый заказ, который ожидает обработки

Пример такого ответа:
```
[
  {
    "phone":   "380365552233", 
    "id_shop": "800600", 
    "test":    false,        

    "state":     "New",
    "order_num": "000001",
    "shipping":  "pickup",
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
 },{
    "phone":   "380367773355", 
    "id_shop": "700100", 
    "test":    false,        

    "state":     "New",
    "order_num": "000002",
    "shipping":  "pickup",
    "data": [{
        "id": "75748",
        "quant": 1.0,
        "price": 25.70
    }]
  }
] 
```

В случае отсутствия заказов для сети, будет получен пустой ответ.

### Прослушивание и бронирование
[NATS] метод. Real-time соединение.
Данный метод используется для прослушивания запросов от клиентов, и обратного ответа по принципу Request–Response.
Для централизованного забора и бронирования заказов, сети достаточно одного соединения для прослушивания.
При распределенном способе получения заказов, устанавливается отдельное, уникальное соединение (например в каждой торговой точке).

Запросы от клиентов будут приходить в следующем формате:
```
{
  "phone":     "string", // Телефон пользователя 
  "id_shop":   "string", // Идентификатор торговой точки 
  "test":      false,    // Флаг тестового запроса
  
  "order_num": "string", // Номер брони
  "shipping":  "string", // Способ доставки товара
   "data": [{
      "id": "string",    // Идентификатор товара
      "quant": 0.0,      // Количество
      "price": 0.0       // Цена
   }]
}
```

Где поле `"shipping"` описывает способ доставки заказа:
* `pickup`  - заказ клиент заберет самостоятельно.
* `deliver` - заказ необходимо доставить клиенту.

Поле `state` описывает текущее состояние заказа:
* `Confirmed` - заказ принят, бронь зарезервирована.
* `Updated`   - запрос в аптеку не верен, повторите запрос с новыми данными (которые выдаются торговой точкой)

Пример запроса от клиента:
```
{
  "phone":     "380365552233", 
  "id_shop":   "800600", 
  "test":       false,
  
  "order_num": "866523",
  "shipping":  "pickup",
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
   }]
}
```

Отвечает торговая точка следующим форматом:
```
{
  "phone":   "string",   // Телефон пользователя 
  "id_shop": "string",   // Идентификатор торговой точки 
  "test":    false,      // Флаг тестового запроса      

  "state":     "string", // Статус обработки запроса
  "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
  "order_num": "string", // Номер брони в аптеке
  "shipping":  "string", // Способ доставки товара
    "data": [{
        "id": "string",  // Идентификатор товара
        "quant": 0.0,    // Количество
        "price": 0.0     // Цена
    }]
}
```

Пример такого ответа:
```
{
  "phone":   "380365552233", 
  "id_shop": "800600", 
  "test":    false,        

  "state":     "Confirmed",
  "order_exp": 11154655,
  "order_num": "012345",
  "shipping":  "pickup",
    "data": [{
        "id": "56548",
        "quant": 1.0,
        "price": 35.10
    }]
}
```

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом заказа**.
  
### `/upd-order`
[HTTP] метод. Запрос на обновления данных по `заказу` в `конкретной` торговой точке.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" -u login:password http://{addr}/upd-order
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - адрес API, который вы можете узнать у вашего менеджера.
- `login`      - логин HTTP аутентификации (`booking` - для участия в бронировании).
- `password`   - пароль HTTP аутентификации (ключ облачной авторизации).

Формат запроса на обновления данных:
```
{
  "phone":   "string",   // Телефон пользователя 
  "id_shop": "string",   // Идентификатор торговой точки 
  "test":    false,      // Флаг тестового запроса      

  "state":     "string", // Статус обработки запроса
  "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
  "order_num": "string", // Номер брони в аптеке
  "shipping":  "string", // Способ доставки товара
    "data": [{
        "id": "string",  // Идентификатор товара
        "quant": 0.0,    // Количество
        "price": 0.0     // Цена
    }]
}
```

Где поле `"shipping"` описывает способ доставки заказа:
* `pickup`  - заказ клиент заберет самостоятельно.
* `deliver` - заказ необходимо доставить клиенту.

Поле `"state"` описывает текущее состояние брони:
* `Confirmed` - заказ подтвержден и зарезервирован в торговой точке.
* `Updated`   - заказ изменен со стороны торговой точки
* `Changed`   - заказ был изменен покупателем
* `Completed` - заказ был продан покупателю
* `Canceled`  - заказ был отменен торговой точкой, либо покупателем

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом заказа**.

Пример данного запроса:
```
{
  "phone":   "380365552233", 
  "id_shop": "800600", 
  "test":    false,        

  "state":     "Confirmed",
  "order_exp": 11154655,
  "order_num": "012345",
  "shipping":  "pickup",
    "data": [{
        "id": "56548",
        "quant": 1.0,
        "price": 35.10
    }]
}
```
  

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[TLS]:https://ru.wikipedia.org/wiki/TLS
[NATS]:http://nats.io
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
