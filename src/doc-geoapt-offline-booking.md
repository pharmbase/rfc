# API Offline бронирования данных в geoapteka.ua/ru для аптечных сетей
*Этот файл поддерживается в формате [Markdown]*

## Соглашения
1. Протокол передачи данных [HTTP]

2. Формат приема-передачи данных [JSON] созданный в кодировке [UTF-8] без [BOM].

3. Коды состояния [стандартные](http://en.wikipedia.org/wiki/List_of_HTTP_status_codes) и возвращаются всегда. Клиент имеет право на их интерпретацию. Ошибки могут быть дополнительно подробно описаны в теле ответа запроса.

4. Обмен данными происходит посредством кодов из каталога компании Морион.

5. Возможны следующие коды состояния:
  * `200` - запрос выполнен успешно.
  * `500` - внутренняя ошибка сервиса.
  В случае получение статуса `500`, в теле ответа будет содержатся `"string"` поле с описанием ошибки.
  
## Принцип работы

### Обмен данными

1. При работе с АПИ, используется корпоративный ключ, выдаваемый при подписании договора.

2. До момента первого запроса (на получение данных, либо тестового) сеть является неопознанной и данных не получит.
В дальнейшем АПИ работает с сетью как "проверенной" и выдает ей информацию для работы.

3. Согласно регламенту, у сети есть 30 минут на обработку заказа. Если в отведенное время сеть не обработала заказ, он передается на внутреннюю службу обработки Morion, и в дальнейшем, будет недоступен для сети.

4. Предусмотрен вариант демонстрационного бронирования, при котором торговая точка получит специальный флаг, который информирует ее о том, что клиент не намерен реально бронировать товар.
В этом случае, торговая точка просто отдает данные, помечая ее соответствующим статусом, но реальное бронирование по остаткам не выполняет.

## Методы

### `/network_req`
Запрос на получение всех заказов для предоставленного ключа.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/cli/network_req?key={corp_key}
```
Где:
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.
- `{corp_key}` - корпоративный ключ, например: `c496a21648577437d4e695c`

Формат запроса на получение данных:
```
["string"] // Перечень идентификаторов торговых точек, по которым необходимо получить заказы
```

Пример данного запроса:
```
["111222", "333444", "5556667"]
```

Допускается вариант, при котором торговая сеть может получить все заказы по корпоративному ключу, в таком случае, в запросе отправляется пустой массив.
Например:
```
[]
```

В случае успеха, будет получен ответ от АПИ в следующем формате:
```
[
 {
   "phone":   "string",   // Телефон пользователя 
   "id_shop": "string",   // Идентификатор торговой точки 
   "test":    false,      // Флаг тестового запроса      

   "state":     "string", // Статус обработки запроса
   "order_num": "string", // Номер брони
    "data": [{
        "id": "string",   // Идентификатор товара
        "quant": 0.0,     // Количество
        "price": 0.0      // Цена
    }]
  }
] 
```

Пример такого ответа:
```
[
  {
    "phone":   "380365552233", 
    "id_shop": "800600", 
    "test":    false,        

    "state":     "New",
    "order_num": "000001",
    "data": [{
        "id": "56548",
        "quant": 2.0,
        "price": 15.40
    },{
        "id": "84655",
        "quant": 1.0,
        "price": 156.88
    }]
 },{
    "phone":   "380367773355", 
    "id_shop": "700100", 
    "test":    false,        

    "state":     "New",
    "order_num": "000002",
    "data": [{
        "id": "75748",
        "quant": 1.0,
        "price": 25.70
    }]
  }
] 
```

Где `"state"` описывает текущее состояние брони:
* `New` - новый заказ, который ожидает обработки

В случае отсутствия заказов для сети, будет получен пустой ответ. (null в теле ответа)


### `/network_upd`
Запрос на обновления данных по `заказу` в `конкретной` торговой точке.

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/cli/network_upd?key={corp_key}
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.
- `{corp_key}` - корпоративный ключ, например: `c496a21648577437d4e695c`

Формат запроса на обновления данных:
```
{
  "phone":   "string",   // Телефон пользователя 
  "id_shop": "string",   // Идентификатор торговой точки 
  "test":    false,      // Флаг тестового запроса      

  "state":     "string", // Статус обработки запроса
  "order_exp": 0,        // Срок истечения брони в аптеке, в формате Unixtime (в случае успешного бронирования)
  "order_num": "string", // Номер брони в аптеке
    "data": [{
        "id": "string",  // Идентификатор товара
        "quant": 0.0,    // Количество
        "price": 0.0     // Цена
    }]
}
```

Где `"state"` описывает текущее состояние брони:
* `Confirmed` - заказ подтвержден и зарезервирован в торговой точке.
* `Updated`   - заказ изменен со стороны торговой точки
* `Changed`   - заказ был изменен покупателем
* `Completed` - заказ был продан покупателю
* `Canceled`  - заказ был отменен торговой точкой, либо покупателем

Во всех вышеописанных случаях отправляется *полный набор данных*, **с внесенными в них изменениями и соответствующим статусом**.

Пример данного запроса:
```
{
  "phone":   "380365552233", 
  "id_shop": "800600", 
  "test":    false,        

  "state":     "Confirmed",
  "order_exp": 11154655,
  "order_num": "012345",
    "data": [{
        "id": "56548",
        "quant": 1.0,
        "price": 35.10
    }]
}
```

### `/test_req`
Тестовый запрос, которым сеть может сымитировать запрос со стороны ГеоАптеки. Позволяет самостоятельно составлять заказ (в кодах Мориона).

Пример команды при помощи служебной программы [cURL]:
```sh
curl -X POST -T "order.json" http://{addr}/cli/test_req?key={corp_key}
```
Где: 
- `order.json` - набор данных JSON-формата.
- `{addr}`     - IP-адрес API, который вы можете узнать у вашего менеджера.
- `{corp_key}` - корпоративный ключ, например: `c496a21648577437d4e695c`

Формат тестового запроса:
```
{
  "agent": "string",         // Маркер точки запроса
  "phone": "string",         // Телефон пользователя 
  "shops": [{
        "id_shop": "string", // Идентификатор торговой точки   
    "data": [{
        "id": "string",      // Идентификатор товара
        "quant": 0.0,        // Количество
        "price": 0.0         // Цена
    }]
  }]
}
```

Все заказы, сформированные тестовым запросом, получат маркер `"test": true`.
Обрабатываются тестовые заказы, теми же методами, что и реальные. 

Пример тестового запроса:
```
{
  "agent": "CorpName",
  "phone": "380632670315",
  "shops": [{
        "id_shop": "700555",   
    "data": [{
        "id": "45600",
        "quant": 5.0,
        "price": 35.0
    },{
        "id": "500600",
        "quant": 1.0,
        "price": 153.45
    }]
},{     "id_shop": "800900",   
    "data": [{
        "id": "400800",
        "quant": 2.0,
        "price": 13.0
    }]
  }]
}
```

[Markdown]:https://ru.wikipedia.org/wiki/Markdown
[JSON]:http://json.org/json-ru.html
[UTF-8]:https://ru.wikipedia.org/w/index.php?title=UTF-8
[BOM]:https://ru.wikipedia.org/w/index.php?oldid=70741439
[HTTP]:https://ru.wikipedia.org/wiki/HTTP
[cURL]:https://ru.wikipedia.org/wiki/CURL
